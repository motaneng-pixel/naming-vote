<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>æ©Ÿå™¨äººå‘½åå¤§å‹Ÿé›†ï¼</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', å¾®è»Ÿæ­£é»‘é«”, Arial, sans-serif; 
            margin: 0;
            font-weight: bold;
            min-height: 100vh;
            width: 100vw;
            background: #f9faf9;
            position: relative;
            box-sizing: border-box;
            /* èƒŒæ™¯åœ–ç‰‡èˆ‡æ·¡åŒ– */
            background-image: url('ChatGPT Image 2025å¹´7æœˆ22æ—¥ ä¸Šåˆ11_32_16.png');
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
        }
        body::before {
            content: "";
            position: fixed;
            left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(255,255,255,0.78); /* èª¿æ•´æ·¡åŒ–ç¨‹åº¦ */
            pointer-events: none;
            z-index: 0;
        }
        body > * { position: relative; z-index: 1; }
        .main-container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 30px 12px 40px 12px;
        }
        .banner-title { font-size: 2.3em; font-weight: bold; margin-bottom: 18px; color: #19618a; }
        .intro { font-size: 1.1em; line-height: 1.8; color: #233a45; margin-bottom:30px;}
        .divider { border: none; height: 2.5px; background: linear-gradient(90deg, #86b3ff 0%, #f2b5f3 100%); margin: 38px 0 22px 0; border-radius: 2px; opacity: 0.7; }
        #posts { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .post { border: 1px solid #ccc; padding: 8px; background: #f9f9f9; width: 19ch; min-width: 19ch; max-width: 19ch; display: flex; flex-direction: column; align-items: flex-start; }
        .post-order { text-align: center; font-weight: bold; color: #007bff; margin-bottom: 5px; font-size: 1.15em; width: 100%; }
        .proposal-title { font-size: 1.45em; font-weight: bold; margin-bottom: 6px; width: 100%; word-break: break-all;}
        .post-desc { margin-bottom: 6px; width: 100%; font-size: 1em; }
        .post-empid, .post-name { color: #555; font-size: 0.95em; margin-bottom: 1px; width: 100%; }
        .votes { font-weight: bold; margin-left: 5px; }
        .fancy-btn { display: inline-block; padding: 10px 38px; font-size: 1.1em; font-weight: bold; color: #fff; background: linear-gradient(90deg, #5bb3fd 0%, #b093fc 100%); border: none; border-radius: 25px; cursor: pointer; transition: all 0.19s; letter-spacing: 1.5px;}
        .fancy-btn:hover { background: linear-gradient(90deg, #b093fc 0%, #5bb3fd 100%); color: #f7f7fa;}
        .delete-btn { margin-left:8px; color:#fff; background:#e57373; border:none; padding:6px 18px; border-radius:8px; cursor:pointer; font-weight: bold; font-size: 1em;}
        .delete-btn:hover { background: #d32f2f;}
        button { font-family: inherit; }
        .field { margin-bottom: 6px; display: block; font-weight: bold; }
    </style>
</head>
<body>
<div class="main-container">
    <div class="banner-title" style="text-align:center;">æ©Ÿå™¨äººå‘½åå¤§å‹Ÿé›†ï¼</div>
<div class="intro" style="text-align:center;">
    æˆ‘å€‘æ­£åœ¨å°‹æ‰¾ä¸€å€‹å±¬æ–¼è­·ç†å•ç­” AI çš„è¶…å¼·åå­—ï¼<br>
    ç¾åœ¨å°±ä¾†æŠ•ç¨¿ï¼Œåªè¦ 5å­—ä»¥å…§ï¼Œä½ çš„ä¸€å¥è©±å¯èƒ½æˆç‚ºå…¨é™¢ AI çš„æ–°æ‹›ç‰Œ ğŸ¤–âœ¨<br><br>
    <b>ğŸ“¨ æŠ•ç¨¿é€å¥½åº·ï¼š</b><br>
    ğŸ’Œ å‰100åæŠ•ç¨¿è€…ï¼š 50å…ƒç¦®åˆ¸<br>
    ğŸ† ç¥¨é¸ç¬¬ä¸€åï¼š 500å…ƒç¦®åˆ¸<br><br>
    â³ æŠ•ç¨¿æˆªæ­¢ï¼šXXXXå¹´XXæœˆXXæ—¥<br>
    ğŸ—³ï¸ ç¥¨é¸é–‹æ”¾ï¼š2025å¹´8æœˆ19æ—¥ï¼ˆä¸€ï¼‰æ—©ä¸Š9:00 èµ·
</div>

    <hr class="divider">
    <section id="postForm">
        <h2>å±•ç¾å‰µæ„å‘½å</h2>
        <label class="field">ææ¡ˆåç¨± (5å­—ä»¥å…§)ï¼š<input type="text" id="proposal" size="30" oninput="limitProposalInput(this)"></label>
        <label class="field">å‘½åä»‹ç´¹ï¼š<input type="text" id="desc" size="40"></label>
        <label class="field">å“¡ç·¨ï¼š<input type="text" id="empid" size="10"></label>
        <label class="field">å§“åï¼š<input type="text" id="name" size="10"></label>
        <button class="fancy-btn" onclick="addPost()">æŠ•ç¨¿</button>
    </section>
    <hr class="divider">
    <section id="voteSection">
        <h2>æ‰€æœ‰æŠ•ç¨¿</h2>
        <div id="posts"></div>
        <div id="admin-login" style="margin-bottom:18px;">
            <input type="password" id="adminPwd" placeholder="ç®¡ç†å¯†ç¢¼">
            <button class="fancy-btn" onclick="adminLogin()">ç®¡ç†ç™»å…¥</button>
        </div>
        <button id="exportBtn" onclick="exportCSV()" style="display:none;">åŒ¯å‡º CSV</button>
    </section>
</div>
<script>
const SHEET_API = "https://script.google.com/macros/s/AKfycbwlEE77nL30ssotj2pQWnPJ_Xm2uoFPedI4AacKVa40Wrxx0GybMBi-NdgNHcypPbBAbw/exec";
let isAdmin = false;
let posts = [];
const voteStartTime = new Date(Date.now() - 1000);

function limitProposalInput(input) {
    let val = input.value;
    let zhCount = (val.match(/[\u4e00-\u9fff]/g) || []).length;
    let enCount = (val.match(/[A-Za-z]/g) || []).length;
    let otherCount = val.length - zhCount - enCount;
    if (zhCount > 0) {
        let result = '';
        let count = 0;
        for (let ch of val) {
            if (/[\u4e00-\u9fff]/.test(ch)) count++;
            else count += 0.5;
            if (count <= 5) result += ch;
            else break;
        }
        input.value = result;
    } else {
        input.value = val.slice(0, 15);
    }
}

// è®€å– Google Sheet æŠ•ç¨¿åŠç¥¨æ•¸
function fetchPosts() {
    fetch(SHEET_API)
    .then(res => res.json())
    .then(rows => {
        // è·³éç¬¬ä¸€è¡Œæ¨™é¡Œ
        posts = rows.slice(1).map((r, i) => ({
            sheetRow: i + 2, // åœ¨ Google Sheet çš„è¡Œæ•¸(å«æ¨™é¡Œ)ï¼ˆæŠ•ç¥¨è¦ç”¨ï¼‰
            order: r[0] || (i + 1), // å–Aæ¬„æµæ°´ç·¨è™Ÿï¼Œæ²’æœ‰å‰‡ç”¨é †åº
            proposal: r[1],
            desc: r[2],
            empid: r[3],
            name: r[4],
            votes: parseInt(r[5]) || 0
        }));
        renderPosts();
    });
}

function renderPosts() {
    const postsDiv = document.getElementById('posts');
    postsDiv.innerHTML = '';
    const now = new Date();
    posts.forEach((post, idx) => {
        const postDiv = document.createElement('div');
        postDiv.className = 'post';
        const canVote = now >= voteStartTime;
        postDiv.innerHTML = `
            <div class="post-order">#${post.order}</div>
            <div class="proposal-title">${post.proposal}</div>
            <div class="post-desc">${post.desc}</div>
            <div class="post-empid">å“¡ç·¨ï¼š${post.empid}</div>
            <div class="post-name">å§“åï¼š${post.name}</div>
            <div style="margin-top:8px;">
                <span class="votes">ç¥¨æ•¸: ${post.votes || 0}</span>
                <button onclick="vote(${idx})" ${canVote ? '' : 'disabled style="opacity:0.5;cursor:not-allowed;"'}>
                    ${canVote ? 'æŠ•ç¥¨' : 'å°šæœªé–‹æ”¾'}
                </button>
                ${isAdmin ? `<button onclick="deletePost(${idx})" class="delete-btn">åˆªé™¤</button>` : ''}
            </div>`;
        postsDiv.appendChild(postDiv);
    });
    const totalVotes = posts.reduce((sum, post) => sum + (post.votes || 0), 0);
    const totalDiv = document.createElement('div');
    totalDiv.style.gridColumn = '1 / -1';
    totalDiv.style.marginTop = '20px';
    totalDiv.innerHTML = `<b>ç¸½æŠ•ç¥¨æ•¸ï¼š</b>${totalVotes}`;
    postsDiv.appendChild(totalDiv);
}

function addPost() {
    const proposal = document.getElementById('proposal').value.trim();
    const desc = document.getElementById('desc').value.trim();
    const empid = document.getElementById('empid').value.trim();
    const name = document.getElementById('name').value.trim();
    let zhCount = (proposal.match(/[\u4e00-\u9fff]/g) || []).length;
    let enCount = (proposal.match(/[A-Za-z]/g) || []).length;
    let otherCount = proposal.length - zhCount - enCount;
    let isValid = false;
    if (zhCount > 0) isValid = (zhCount + Math.ceil(otherCount/2) <= 5);
    else isValid = proposal.length <= 15;

    if (!isValid) {
        alert('ææ¡ˆåç¨±å¿…é ˆç‚ºä¸­æ–‡5å­—ä»¥å…§æˆ–è‹±æ–‡15å­—ä»¥å…§ï¼');
        return;
    }
    if (proposal && desc && empid && name) {
        fetch(SHEET_API, {
            method: "POST",
            body: JSON.stringify({ proposal, desc, empid, name }),
            headers: { "Content-Type": "application/json" }
        }).then(r=>r.text()).then(res=>{
            if(res === "success"){
                alert("æŠ•ç¨¿æˆåŠŸï¼");
                document.getElementById('proposal').value = '';
                document.getElementById('desc').value = '';
                document.getElementById('empid').value = '';
                document.getElementById('name').value = '';
                fetchPosts();
            } else {
                alert("æŠ•ç¨¿å¤±æ•—ï¼Œè«‹é‡è©¦ï¼");
            }
        }).catch(()=>{
            alert("é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
        });
    } else {
        alert('è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½');
    }
}

// åªèƒ½æŠ•ä¸€ç¥¨
function vote(idx) {
    const now = new Date();
    if (now < voteStartTime) {
        alert('æŠ•ç¥¨å°šæœªé–‹æ”¾ï¼Œå°‡æ–¼ 2025/8/19 æ—©ä¸Š 9:00 é–‹å§‹');
        return;
    }
    if (localStorage.getItem('hasVoted')) {
        alert('ä½ å·²ç¶“æŠ•éç¥¨ï¼Œä¸èƒ½é‡è¤‡æŠ•ç¥¨ï¼');
        return;
    }
    const sheetRow = posts[idx].sheetRow; // æŠ•ç¥¨ç”¨sheetå¯¦éš›è¡Œ
    fetch(SHEET_API, {
        method: "PUT",
        body: JSON.stringify({ rowIndex: sheetRow }),
        headers: { "Content-Type": "application/json" }
    }).then(r=>r.text()).then(res=>{
        if(res === "success"){
            alert("æŠ•ç¥¨æˆåŠŸï¼");
            localStorage.setItem('hasVoted', 'yes');
            fetchPosts();
        } else {
            alert("æŠ•ç¥¨å¤±æ•—ï¼Œè«‹é‡è©¦ï¼");
        }
    }).catch(()=>{
        alert("é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
    });
}

function deletePost(idx) {
    alert('å¦‚è¦é›²ç«¯åˆªé™¤éœ€é€²éš Apps Script æ”¯æ´ï¼Œé è¨­åƒ…ç§»é™¤ç•«é¢');
    posts.splice(idx, 1);
    posts.forEach((p, i) => p.order = i + 1);
    renderPosts();
}

function exportCSV() {
    let csv = "æŠ•ç¨¿é †åº,ææ¡ˆåç¨±,å‘½åä»‹ç´¹,å“¡ç·¨,å§“å,ç¥¨æ•¸\n";
    posts.forEach(p => {
        csv += `${p.order},"${p.proposal}","${p.desc}","${p.empid}","${p.name}",${p.votes || 0}\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'æŠ•ç¨¿è³‡æ–™.csv';
    a.click();
    URL.revokeObjectURL(url);
}

function adminLogin() {
    const pwd = document.getElementById('adminPwd').value;
    if (pwd === "12345") {
        isAdmin = true;
        document.getElementById('exportBtn').style.display = "";
        document.getElementById('admin-login').style.display = "none";
        alert("ç®¡ç†æ¨¡å¼ç™»å…¥æˆåŠŸï¼");
        renderPosts();
    } else {
        alert("å¯†ç¢¼éŒ¯èª¤ï¼");
    }
}

// é é¢ä¸€è¼‰å…¥å°±è‡ªå‹•è®€è³‡æ–™
fetchPosts();
</script>
</body>
</html>
